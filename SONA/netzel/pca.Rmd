---
title: "SVCNorming"
author: "Arian Mobasser"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    highlight: tango
    theme: united
    toc: true
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
---

```{r setup, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(rio)
library(foreign)
library(psych)
#library(OpenMx)

```

# load svc data
```{r import svc}

svc <- import("~/Downloads/SVC_short.csv")

```

# exclude subjects who didn't do the survey
```{r examine svc}

# head(svc)
# str(svc)
# 
# summary(svc) # note that there are a couple missing values

svc <- svc %>%
  filter(!(is.na(SVC_1) & is.na(SVC_2) & is.na(SVC_3)))

```

# load item information
```{r}

svc_items <- import("~/Downloads/SVC_itemnames.xlsx") %>%
    t() %>%
    as.data.frame() %>%
    rename("text" = `1`) %>%
    extract(text, "text", ".*- (.*)") %>%
    mutate(item = rownames(.))
```

## scree plot
```{r}
VSS.scree(cor(svc[,-1], use = "pairwise.complete.obs"))
```

# PCA, 6 factors, no rotation
## Run PCA
```{r}
pca.var = principal(svc[,-1], rotate = "rotate", nfactors = 6, missing = TRUE)
loadings = data.frame(loading = pca.var$loadings[,1:6]) %>%
  mutate(item = rownames(.))

pca.var
```

## Merge items and loadings
```{r}
merged = loadings %>%
    left_join(., svc_items, by = "item") %>% 
    select(item, text, everything())
```

## Sort by loading on component 1
```{r}
merged %>%
  arrange(desc(loading.PC1))
```

## Sort by loading on component 2
```{r}
merged %>%
  arrange(desc(loading.PC2))
```

## Sort by loading on component 3
```{r}
merged %>%
  arrange(desc(loading.PC3))
```

## Sort by loading on component 4
```{r}
merged %>%
  arrange(desc(loading.PC4))
```

## Sort by loading on component 5
```{r}
merged %>%
  arrange(desc(loading.PC5))
```

## Sort by loading on component 6
```{r}
merged %>%
  arrange(desc(loading.PC6))
```

# PCA, 3 factors promax
## Run PCA
```{r}
pca.var2 = principal(svc[,-1], rotate = "promax", nfactors = 3, missing = TRUE)
loadings2 = data.frame(loading = pca.var2$loadings[,1:3]) %>%
  mutate(item = rownames(.))

pca.var2
```

## Merge items and loadings
```{r}
merged = loadings2 %>%
    left_join(., svc_items, by = "item") %>% 
    select(item, text, everything())
```

## Sort by loading on component 1
```{r}
merged %>%
  arrange(desc(loading.RC1)) %>%
  slice(1:30)
```

## Sort by loading on component 2
```{r}
merged %>%
  arrange(desc(loading.RC2)) %>%
  slice(1:40)
```

## Sort by loading on component 3
```{r}
merged %>%
  arrange(desc(loading.RC3))
```

# choose words
```{r}
words = left_join(merged, select(loadings, item, loading.PC1)) %>%
  rename("social" = loading.RC1,
         "ill-being" = loading.RC2,
         "health" = loading.RC3,
         "well-being" = loading.PC1)

wellbeing = words %>%
  arrange(desc(`well-being`)) %>%
  slice(1:40) %>%
  filter(!item %in% c("SVC_135","SVC_122","SVC_134","SVC_98","SVC_142","SVC_131","SVC_138","SVC_142","SVC_27","SVC_115","SVC_114","SVC_139","SVC_162","SVC_130","SVC_60","SVC_168","SVC_141","SVC_120","SVC_30","SVC_91","SVC_121", "SVC_83", "SVC_40")) %>%
  bind_cols(condition = rep(1,length(.$text)),
            reverse = rep(0,length(.$text)),
            syllables = c(2, 5, 6, 2, 3, 4, 6, 2, 2, 5, 4, 3, 3, 3, 2, 1, 5, 4)) %>%
  select(text, condition, reverse, syllables, item, everything())

social = words %>%
  arrange(desc(social)) %>%
  slice(1:28) %>%
  filter(!item %in% c("SVC_12", "SVC_156", "SVC_43", "SVC_102", "SVC_128", "SVC_120", "SVC_45", "SVC_99", "SVC_10","SVC_22","SVC_108","SVC_104","SVC_115", "SVC_100")) %>%
  bind_rows(filter(words, item %in% c("SVC_111","SVC_124","SVC_157","SVC_143"))) %>%
  bind_cols(condition = rep(2,length(.$text)),
            reverse = c(rep(0,14), rep(1,4)),
            syllables = c(3, 5, 3, 1, 2, 5, 6, 7, 4,3, 3, 2, 6, 4, 5, 4, 3, 2)) %>%
  select(text, condition, reverse, syllables, item, everything())

illbeing = words %>%
  arrange(desc(`ill-being`)) %>%
  slice(1:21) %>%
  filter(!item %in% c("SVC_94", "SVC_58", "SVC_143")) %>%
  bind_cols(condition = rep(3,length(.$text)),
            reverse = rep(0,length(.$text)),
            syllables = c(2, 3, 2, 5, 4, 2, 1, 1, 6, 3, 2, 2, 2, 5, 3, 2, 5, 3)) %>%
  select(text, condition, reverse, syllables, item, everything()) %>%
  mutate(text = ifelse(text == "fearful of being hurt", "afraid of being hurt", text))
```

# print words
## well-being
```{r}
wellbeing
```

## social
```{r}
social
```

## ill-being
```{r}
illbeing
```

# save words
```{r}
write.table(wellbeing[,1:4], "~/Documents/code/dsnlab/svc/task/design/materials/wellbeing.txt", sep = ',', quote = FALSE, col.names = FALSE, row.names = FALSE)

write.table(social[,1:4], "~/Documents/code/dsnlab/svc/task/design/materials/social.txt", sep = ',', quote = FALSE, col.names = FALSE, row.names = FALSE)

write.table(illbeing[,1:4], "~/Documents/code/dsnlab/svc/task/design/materials/illbeing.txt", sep = ',', quote = FALSE, col.names = FALSE, row.names = FALSE)

```

