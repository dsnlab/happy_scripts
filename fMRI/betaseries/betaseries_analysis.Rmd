---
title: "Beta series analysis"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```

# load packages
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(gtools)
library(GGally)
library(sjstats)
library(lme4)
library(lmerTest)
library(knitr)
```

# define color palettes
```{r}
rois = c("#006989", "#56445D", "#8EC922")
constructs = c("#FEC601", "#F43C13", "#254E70")
instructions = wesanderson::wes_palette("Darjeeling1", 2, "continuous")
valence = c("#119DA4", "#19647E")
```

# source data
```{r}
source("load_data.R")
```

# assess variability
* data is standardized within subject and ROI in `merge_tidy.R`
```{r}
betas %>%
  arrange(desc(meanPE))

# visualize variablity
pe.var = betas %>%
  group_by(subjectID, roi) %>%
  summarize(n = n(),
            mean.roi = mean(meanPE, na.rm = TRUE),
            sd.roi = sd(meanPE, na.rm = TRUE),
            median.roi = median(meanPE, na.rm = TRUE),
            min.roi = min(meanPE, na.rm = TRUE),
            max.roi = max(meanPE, na.rm = TRUE),
            range.roi = max.roi - min.roi)

# median (points = subs)
ggplot(pe.var, aes(roi, median.roi)) +
  geom_boxplot() +
  geom_jitter(alpha = .1) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# sd (points = subs)
ggplot(pe.var, aes(roi, sd.roi)) +
  geom_boxplot() +
  geom_jitter(alpha = .1) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## assess variability within participant
```{r, fig.height=60, fig.width=15}
betas %>%
  group_by(roi) %>%
  mutate(median = median(meanPE, na.rm = TRUE),
         sd3 = 3*sd(meanPE, na.rm = TRUE),
         outlier = ifelse(meanPE > median + sd3 | meanPE < median - sd3, "yes", "no")) %>%
  group_by(subjectID, roi, outlier) %>%
  filter(outlier == "yes") %>%
  arrange(desc(meanPE))

betas %>%
  group_by(roi) %>%
  mutate(median = median(meanPE, na.rm = TRUE),
         sd3 = 3*sd(meanPE, na.rm = TRUE),
         outlier = ifelse(meanPE > median + sd3 | meanPE < median - sd3, "yes", "no")) %>%
  group_by(outlier) %>%
  summarize(n = n()) %>%
  spread(outlier, n) %>%
  mutate(percent = round((yes / (yes = no)) * 100, 2))

# betas %>%
#   group_by(roi) %>%
#   mutate(median = median(meanPE, na.rm = TRUE),
#          sd3 = 3*sd(meanPE, na.rm = TRUE),
#          outlier = ifelse(meanPE > median + sd3 | meanPE < median - sd3, "yes", "no")) %>%
#   ggplot(aes(roi, meanPE)) +
#     geom_jitter(data = filter(outliers, outlier == "yes"), aes(color = outlier), alpha = .5) +
#     geom_text(data = filter(outliers, outlier == "yes"), aes(label = as.character(trial)), size = 2, position = "jitter") +
#     geom_violin() +
#     facet_wrap(~subjectID, ncol = 5, scales = "free") +
#     theme_minimal() +
#     theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# exclude outliers and standardize
* exclude outlier trials that are > 3 SDs from roi median across subs
* standardize within sub and roi
```{r}
betas.ex = betas %>%
  group_by(roi) %>%
  mutate(median = median(meanPE, na.rm = TRUE),
         sd3 = 3*sd(meanPE, na.rm = TRUE),
         outlier = ifelse(meanPE > median + sd3 | meanPE < median - sd3, "yes", "no")) %>%
  filter(outlier == "no") %>%
  select(-c(median, sd3, sdPE, outlier)) %>%
  group_by(subjectID, roi) %>%
  mutate(sd.roi = sd(meanPE, na.rm = TRUE),
         std = meanPE / sd.roi) %>%
  select(-meanPE, -sd.roi) %>%
  spread(roi, std)

betas.ex %>%
  gather(roi, meanPE, unique(as.character(betas$roi))) %>%
  group_by(roi) %>%
  summarize(n = n(),
            mean.roi = mean(meanPE, na.rm = TRUE),
            sd.roi = sd(meanPE, na.rm = TRUE),
            median.roi = median(meanPE, na.rm = TRUE),
            min.roi = min(meanPE, na.rm = TRUE),
            max.roi = max(meanPE, na.rm = TRUE),
            range.roi = max.roi - min.roi)
```

# tidy
* merge datasets
* 1 = yes, 2 = no
* recode negative responses (e.g. no on reversed item = yes) in the social facet
```{r}
data = left_join(betas.ex, task, by = c("subjectID", "trial", "run")) %>%
  extract(subjectID, "subNum", "FP([0-9]{3})", remove = FALSE) %>%
  mutate(instruction = as.factor(instruction),
         construct = as.factor(construct),
         item = as.character(item),
         RT = ifelse(RT == "NaN", NA, RT),
         response = ifelse(response == 1, "yes",
                    ifelse(response == 2, "no", NA)),
         responseNum = ifelse(response == "yes" & reversed == 0, 1,
                       ifelse(response == "yes" & reversed == 1, 0,
                       ifelse(response == "no" & reversed == 0, 0,
                       ifelse(response == "no" & reversed == 1, 1, response)))),
         responseNum = as.integer(responseNum),
         responseYN = ifelse(responseNum == 1, "yes",
                      ifelse(responseNum == 0, "no", responseNum)),
         responseYNswap = ifelse(construct == "ill-being" & responseYN == "yes", "no",
                          ifelse(construct == "ill-being" & responseYN == "no", "yes", responseYN)),
         valence = ifelse(construct %in% c("well-being", "social") & reversed == 0, "positive",
                   ifelse(construct %in% c("well-being", "social") & reversed == 1, "negative",
                   ifelse(construct %in% "ill-being" & reversed == 0, "negative",
                   ifelse(construct %in% "ill-being" & reversed == 1, "positive", NA)))),
         valence = as.factor(valence)) %>%
  ungroup() %>%
  mutate(responseYN = as.factor(responseYN))

# relevel factors
data$valence = relevel(data$valence, "positive")
data$construct = relevel(data$construct, "well-being")
```

# exclude subjects
* Motion exclusions: FP091
* Technical failure: FP080, FP082
* Non-compliance: FP021, FP049, FP085, FP121

```{r}
data.ex = data %>%
  filter(!subjectID %in% c("FP091", "FP080", "FP082", "FP021", "FP049", "FP085", "FP121"))
```

# remove missing data for MLM
```{r}
data.complete = data.ex %>%
  na.omit(.)
```

# describe data
## rois
```{r}
# means and SDs
data.complete %>%
  gather(roi, value, unique(as.character(betas$roi))) %>%
  group_by(roi) %>%
  summarize(n = n(),
            mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE))

# by construct and instruction
data.complete %>%
  gather(roi, value, unique(as.character(betas$roi))) %>%
  group_by(roi, construct, instruction) %>%
  summarize(n = n(),
            mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE)) %>%
  arrange(desc(mean))
```


## responses
* percent = percent of trial on which response was yes

```{r, message=FALSE, warning=FALSE}
# descriptives
data.percent = data.complete %>%
  group_by(construct, instruction, subjectID) %>%
  summarize(sum = sum(responseNum, na.rm = TRUE),
            n = n()) %>%
  mutate(percent = (sum / n) * 100)

data.percent %>%
  group_by(construct, instruction) %>%
  summarize(mean = mean(percent, na.rm = TRUE),
            sd = sd(percent, na.rm = TRUE)) %>%
  arrange(mean) %>%
  mutate_if(is.numeric, round, 2) %>%
  kable(format = "pandoc")

data.percent.swap = data.percent %>%
  mutate(percent = ifelse(construct == "ill-being" & instruction == "self", 100 - percent, percent))

# write csv files
data.percent %>%
  select(subjectID, construct, instruction, percent) %>%
  write.csv(., "wellbeing_scores.csv", row.names = FALSE)

data.percent.swap %>%
  select(subjectID, construct, instruction, percent) %>%
  write.csv(., "wellbeing_scores_swap.csv", row.names = FALSE)
```

# behavioral models
```{r}
# run and summarize model
model.percent = lmer(percent ~ construct*instruction + (1 | subjectID), data = data.percent)
summary(model.percent)

# confidence intervals
cis.percent = confint(model.percent) %>%
  as.data.frame() %>%
  rownames_to_column()

# model fir
r2(model.percent)

# post-hoc t-tests
data.ttests = data.percent %>%
  filter(instruction == "change") %>%
  select(-c(sum, n)) %>%
  spread(construct, percent)

data.frame(test = c("social ill-being", "social well-being", "well-being ill-being "),
           diff = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]]),
              t = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]]),
              df = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]]),
              p = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value)) %>%
    mutate(diff = round(diff, 2),
           df = round(df, 2),
           t = round(t, 2),
           p = round(p, 3),
           p = ifelse(p == 0.000, "< .001", p)) %>%
  kable(format = "pandoc")

data.ttests = data.percent %>%
  filter(instruction == "self") %>%
  select(-c(sum, n)) %>%
  spread(construct, percent)

data.frame(test = c("social ill-being", "social well-being", "well-being ill-being "),
           diff = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]]),
              t = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]]),
              df = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]]),
              p = c(t.test(data.ttests$social, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests$social, data.ttests$`well-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests$`well-being`, data.ttests$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value)) %>%
    mutate(diff = round(diff, 2),
           df = round(df, 2),
           t = round(t, 2),
           p = round(p, 3),
           p = ifelse(p == 0.000, "< .001", p)) %>%
  kable(format = "pandoc")
```

```{r}
# run and summarize model
model.percent.swap = lmer(percent ~ construct*instruction + (1 | subjectID), data = data.percent.swap)
summary(model.percent.swap)

# confidence intervals
cis.percent.swap = confint(model.percent.swap) %>%
  as.data.frame() %>%
  rownames_to_column()

# model fir
r2(model.percent.swap)

# post-hoc t-tests
data.ttests.swap = data.percent.swap %>%
  filter(instruction == "change") %>%
  select(-c(sum, n)) %>%
  spread(construct, percent)

data.frame(test = c("social ill-being", "social well-being", "well-being ill-being "),
           diff = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]]),
              t = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]]),
              df = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]]),
              p = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value)) %>%
    mutate(diff = round(diff, 2),
           df = round(df, 2),
           t = round(t, 2),
           p = round(p, 3),
           p = ifelse(p == 0.000, "< .001", p)) %>%
  kable(format = "pandoc")

data.ttests.swap = data.percent.swap %>%
  filter(instruction == "self") %>%
  select(-c(sum, n)) %>%
  spread(construct, percent)

data.frame(test = c("social ill-being", "social well-being", "well-being ill-being "),
           diff = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$estimate[[1]]),
              t = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$statistic[[1]]),
              df = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]],
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$parameter[[1]]),
              p = c(t.test(data.ttests.swap$social, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests.swap$social, data.ttests.swap$`well-being`, na.action = "na.omit", paired = TRUE)$p.value,
                    t.test(data.ttests.swap$`well-being`, data.ttests.swap$`ill-being`, na.action = "na.omit", paired = TRUE)$p.value)) %>%
    mutate(diff = round(diff, 2),
           df = round(df, 2),
           t = round(t, 2),
           p = round(p, 3),
           p = ifelse(p == 0.000, "< .001", p)) %>%
  kable(format = "pandoc")
```

# model comparison
```{r}
data.complete.mod = data.complete %>%
  mutate(response = as.factor(response),
         valence = as.factor(valence)) %>%
  filter(instruction == "self")
```

## models with valence
```{r}
model.0 = glmer(response ~ construct + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.1 = glmer(response ~ construct + valence + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.2 = glmer(response ~ construct + valence + pgACC + vmPFC + VS + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.3 = glmer(response ~ valence + pgACC*construct + vmPFC*construct + VS*construct + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

# compare models
anova(model.0, model.1, model.2, model.3)

# summarize best fitting model
summary(model.3)

# cis.trial = confint(model.3) %>%
#   as.data.frame() %>%
#   rownames_to_column()
# saveRDS(cis.trial, "CIs")
# cis.trial = readRDS("CIs")

# model fit
r2(model.0)
r2(model.3)
```

## models without valence
```{r}
model.0.noval = glmer(responseYN ~ construct + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.1.noval = glmer(responseYN ~ construct + pgACC + vmPFC + VS + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.2.noval = glmer(responseYN ~ pgACC*construct + vmPFC*construct + VS*construct + (1 | subjectID), 
                family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

# compare models
anova(model.0.noval, model.1.noval, model.2.noval)

# summarize best fitting model
summary(model.2.noval)

# cis.trial.noval = confint(model.2.noval) %>%
#   as.data.frame() %>%
#   rownames_to_column()
# saveRDS(cis.trial.noval, "CIs_noval")
cis.trial.noval = readRDS("CIs_noval")

# model fit
r2(model.0.noval)
r2(model.2.noval)
```

# tables
```{r}
# convert logits to probabilities
logit2prob = function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

model.probs = data.frame(probability = logit2prob(summary(model.3)$coefficients[,1])) %>%
  rownames_to_column() %>%
  rename("parameter" = rowname)

model.probs.noval = data.frame(probability = logit2prob(summary(model.2.noval)$coefficients[,1])) %>%
  rownames_to_column() %>%
  rename("parameter" = rowname)
```

## behavioral model
```{r}
as.data.frame(summary(model.percent)$coefficients) %>%
  rownames_to_column() %>%
  left_join(., cis.percent) %>%
  rename("parameter" = rowname,
         "b" = Estimate,
         "SE" = `Std. Error`,
         "t" = `t value`,
         "p" = `Pr(>|t|)`) %>%
  mutate(parameter = ifelse(parameter == "(Intercept)", "Intercept (well-being, change)",
                     ifelse(parameter == "constructsocial", "Social",
                     ifelse(parameter == "constructill-being", "Ill-being",
                     ifelse(parameter == "instructionself", "Self instruction",
                     ifelse(parameter == "constructsocial:instructionself", "Social x self instruction",
                     ifelse(parameter == "constructill-being:instructionself", "Ill-being x self instruction", parameter))))))) %>%
  select(parameter, b, `2.5 %`, `97.5 %`, everything()) %>%
  mutate(b = round(b, 2),
         `2.5 %` = round(`2.5 %`, 2),
         `97.5 %` = round(`97.5 %`, 2),
         SE = round(SE, 2),
         df = round(df, 2),
         t = round(t, 2),
         p = round(p, 3),
         p = ifelse(p == 0.000, "< .001", p)) %>%
  kable(format = "pandoc")
```

## valence models
### model comparison
```{r}
as.data.frame(anova(model.0, model.1, model.2, model.3)) %>%
  select(AIC, BIC, Chisq, `Chi Df`, `Pr(>Chisq)`) %>%
  rename("X2" = Chisq,
         "df" = `Chi Df`,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         BIC = round(BIC, 2),
         X2 = round(X2, 2),
         df = round(df, 2),
         p = round(p, 3),
         p = ifelse(p == 0.000, "< .001", p)) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "–", .))) %>%
  `rownames<-`(c("Base model", "Valence model", "ROI model", "ROI interaction model")) %>%
  kable(format = "pandoc")
```

### best fitting valence model
```{r}
as.data.frame(summary(model.3)$coefficients) %>%
  rownames_to_column() %>%
  #left_join(., cis.trial) %>%
  rename("parameter" = rowname,
         "b" = Estimate,
         "SE" = `Std. Error`,
         "z" = `z value`,
         "p" = `Pr(>|z|)`) %>%
  left_join(., model.probs, by = "parameter") %>%
  mutate(parameter = ifelse(parameter == "(Intercept)", "Intercept (well-being, positive)",
                     ifelse(parameter == "valencenegative", "Negative",
                     ifelse(parameter == "constructsocial", "Social",
                     ifelse(parameter == "constructill-being", "Ill-being",
                     ifelse(parameter == "pgACC:constructsocial", "pgACC x social",
                     ifelse(parameter == "pgACC:constructill-being", "pgACC x ill-being",
                     ifelse(parameter == "constructsocial:vmPFC", "vmPFC x social",
                     ifelse(parameter == "constructill-being:vmPFC", "vmPFC x ill-being",
                     ifelse(parameter == "constructsocial:VS", "VS x social",
                     ifelse(parameter == "constructill-being:VS", "VS x ill-being", parameter))))))))))) %>%
  mutate(b = round(b, 2),
         #`2.5 %` = round(`2.5 %`, 2),
         #`97.5 %` = round(`97.5 %`, 2),
         `odds ratio` = round(exp(b), 2),
         probability = round(probability, 2),
         SE = round(SE, 2),
         z = round(z, 2),
         p = round(p, 3),
         p = ifelse(p == 0.000, "< .001", p)) %>%
  #select(-probability) %>%
  select(parameter, b, `odds ratio`, everything()) %>% # `2.5 %`, `97.5 %`
  kable(format = "pandoc")
```

## no valence models
### model comparison
```{r}
as.data.frame(anova(model.0.noval, model.1.noval, model.2.noval)) %>%
  select(AIC, BIC, Chisq, `Chi Df`, `Pr(>Chisq)`) %>%
  rename("X2" = Chisq,
         "df" = `Chi Df`,
         "p" = `Pr(>Chisq)`) %>%
  mutate(AIC = round(AIC, 2),
         BIC = round(BIC, 2),
         X2 = round(X2, 2),
         df = round(df, 2),
         p = round(p, 3),
         p = ifelse(p == 0.000, "< .001", p)) %>%
  mutate_if(is.numeric, funs(ifelse(is.na(.), "–", .))) %>%
  `rownames<-`(c("Base model", "ROI model", "ROI interaction model")) %>%
  kable(format = "pandoc")
```

### best fitting model
```{r}
as.data.frame(summary(model.2.noval)$coefficients) %>%
  rownames_to_column() %>%
  left_join(., cis.trial.noval) %>%
  rename("parameter" = rowname,
         "b" = Estimate,
         "SE" = `Std. Error`,
         "z" = `z value`,
         "p" = `Pr(>|z|)`) %>%
  left_join(., model.probs.noval, by = "parameter") %>%
  mutate(parameter = ifelse(parameter == "(Intercept)", "Intercept (well-being)",
                     ifelse(parameter == "constructsocial", "Social",
                     ifelse(parameter == "constructill-being", "Ill-being",
                     ifelse(parameter == "pgACC:constructsocial", "pgACC x social",
                     ifelse(parameter == "pgACC:constructill-being", "pgACC x ill-being",
                     ifelse(parameter == "constructsocial:vmPFC", "vmPFC x social",
                     ifelse(parameter == "constructill-being:vmPFC", "vmPFC x ill-being",
                     ifelse(parameter == "constructsocial:VS", "VS x social",
                     ifelse(parameter == "constructill-being:VS", "VS x ill-being", parameter)))))))))) %>%
  mutate(b = round(b, 2),
         `2.5 %` = round(`2.5 %`, 2),
         `97.5 %` = round(`97.5 %`, 2),
         `odds ratio` = round(exp(b), 2),
         probability = round(probability, 2),
         SE = round(SE, 2),
         z = round(z, 2),
         p = round(p, 3),
         p = ifelse(p == 0.000, "< .001", p)) %>%
  #select(-probability) %>%
  select(parameter, b, `2.5 %`, `97.5 %`, `odds ratio`, everything()) %>%
  kable(format = "pandoc")
```

## ROI means and correlations
[https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5383908/](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5383908/)  
```{r}
# library(rmcorr)
# 
# # pgACC - vmPFC
# (pgACC_vmPFC = data.complete.mod %>%
#    filter(instruction == "self") %>%
#    mutate(subjectID = as.factor(subjectID)) %>%
#    select(subjectID, pgACC, vmPFC) %>%
#    rmcorr(subjectID, pgACC, vmPFC, .))
# 
# (pgACC_VS = data.complete.mod %>%
#    filter(instruction == "self") %>%
#    mutate(subjectID = as.factor(subjectID)) %>%
#    select(subjectID, pgACC, VS) %>%
#    rmcorr(subjectID, pgACC, VS, .))
# 
# (vmPFC_VS = data.complete.mod %>%
#    filter(instruction == "self") %>%
#    mutate(subjectID = as.factor(subjectID)) %>%
#    select(subjectID, vmPFC, VS) %>%
#    rmcorr(subjectID, vmPFC, VS, .))
# 
# # meansq
# mean_table = data.complete.mod %>%
#   gather(roi, value, pgACC, vmPFC, VS) %>%
#   group_by(roi) %>%
#   summarize(M = round(mean(value, na.rm = TRUE), 2),
#             SD = round(sd(value, na.rm = TRUE), 2)) %>%
#   mutate(order = ifelse(roi == "pgACC", 1,
#                  ifelse(roi == "vmPFC", 2, 3)),
#          roi = ifelse(roi == "pgACC", "1. pgACC",
#                ifelse(roi == "vmPFC", "2. vmPFC", "3. VS"))) %>%
#   rename("ROI" = roi) %>%
#   arrange(order) %>%
#   select(-order)
# 
# # table
# corr_table = data.frame(ROI = c("1. pgACC", "2. vmPFC", "3. VS"),
#            `1` = c("--", paste0(round(pgACC_vmPFC[[1]],2), " [",round(pgACC_vmPFC[[4]][1],2),", ",round(pgACC_vmPFC[[4]][2],2),"]"),
#                    paste0(round(pgACC_VS[[1]],2), " [",round(pgACC_VS[[4]][1],2),", ",round(pgACC_VS[[4]][2],2),"]")),
#            `2` = c("", "--", paste0(round(vmPFC_VS[[1]],2), " [",round(vmPFC_VS[[4]][1],2),", ",round(vmPFC_VS[[4]][2],2),"]")),
#            `3` = c("", "", "--"),
#            check.names = FALSE)
# 
# mean_table %>%
#   full_join(., corr_table) %>%
#   knitr::kable(format = "pandoc", caption = "Repeated Measures Correlations Between ROIs (n = 3670). All correlations are statistically significant, p < .001. 95% confidence intervals are bracketed")
# 
# # detach package
# detach("package:rmcorr", unload = TRUE)
```

# paper plots
```{r}
beh.plot = data.percent %>%
  ggplot(aes(construct, percent, color = instruction)) + 
    geom_point(aes(group = interaction(subjectID, construct)), alpha = .1) + 
    geom_line(aes(group = interaction(subjectID, instruction)), alpha = .1) + 
    stat_summary(aes(group = instruction), fun.y = "mean", geom = "point") +
    stat_summary(aes(group = instruction), fun.data = "mean_cl_boot", geom = "linerange", size = 1.5) +
    stat_summary(aes(group = instruction), fun.y = mean, geom = "line", size = 1.5) +
    labs(x = "", y = "percent yes\n") +
    scale_color_manual(values = wesanderson::wes_palette("Darjeeling1", 1.5, "continuous")) + 
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium", colour = "black"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.915, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

beh.all.plot = data.percent %>%
  ungroup() %>%
  mutate(percent.swap = ifelse(construct == "ill-being" & instruction == "self", 100 - percent, percent)) %>%
  gather(model, percent, percent, percent.swap) %>%
  filter(model == "percent" | (model == "percent.swap" & instruction == "self")) %>%
  mutate(instruction.rev = ifelse(model == "percent.swap", "ill-being self reverse-coded", as.character(instruction)),
         instruction.rev = as.factor(instruction.rev)) %>%
  ggplot(aes(construct, percent, color = instruction.rev)) + 
    geom_point(aes(group = interaction(subjectID, construct)), alpha = .08) + 
    geom_line(aes(group = interaction(subjectID, instruction.rev)), alpha = .08) + 
    stat_summary(aes(group = instruction.rev), fun.y = "mean", geom = "point") +
    stat_summary(aes(group = instruction.rev), fun.data = "mean_cl_boot", geom = "linerange", size = 1.5) +
    stat_summary(aes(group = instruction.rev), fun.y = mean, geom = "line", size = 1.5) +
    labs(x = "", y = "percent yes\n") +
    scale_color_manual(name = "instruction", values = c("#FF0000", "#F2AD00", "#5BBCD6")) + 
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium", colour = "black"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.86, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

plot.data = data.percent %>%
  ungroup() %>%
  mutate(`ill-being` = ifelse(construct == "ill-being" & instruction == "self", 100 - percent, percent)) %>%
  rename("standard" = percent) %>%
  gather(model, percent, standard, `ill-being`) %>%
  filter(model == "standard" | (model == "ill-being" & instruction == "self")) %>%
  mutate(model = ifelse(model == "standard", "", model))


beh.all.plot.line = plot.data %>% 
  filter(!model == "ill-being") %>%
  ggplot(aes(construct, percent, color = instruction)) + 
    geom_point(aes(group = interaction(subjectID, construct, model)), alpha = .08) + 
    geom_line(aes(group = interaction(subjectID, instruction, model)), alpha = .08) + 
    stat_summary(aes(group = interaction(instruction)), fun.y = "mean", geom = "point") +
    stat_summary(aes(group = interaction(instruction)), fun.data = "mean_cl_boot", geom = "linerange", size = 1.25) +
    stat_summary(aes(group = interaction(instruction)), fun.y = mean, geom = "line", size = 1.25) +
    stat_summary(data = filter(plot.data, model == "ill-being"), aes(group = model), fun.y = "mean", geom = "point") +
    stat_summary(data = filter(plot.data, model == "ill-being"), aes(group = model), fun.data = "mean_cl_boot", geom = "linerange", size = 1.25) +
    stat_summary(data = filter(plot.data, model == "ill-being"), aes(group = model, linetype = model), fun.y = mean, geom = "line", size = 1.25) +  
    labs(x = "", y = "percent yes\n") +
    scale_color_manual(values = wesanderson::wes_palette("Darjeeling1", 2, "continuous")) + 
    scale_linetype_manual(name = "reverse-coded", values = "twodash") +
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium", colour = "black"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.box = "horizontal",
          legend.position = c(.83, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

beh.swap.plot = data.percent.swap %>%
  ggplot(aes(construct, percent, color = instruction)) + 
    geom_point(aes(group = interaction(subjectID, construct)), alpha = .1) + 
    geom_line(aes(group = interaction(subjectID, instruction)), alpha = .1) + 
    stat_summary(aes(group = instruction), fun.y = "mean", geom = "point") +
    stat_summary(aes(group = instruction), fun.data = "mean_cl_boot", geom = "linerange", size = 1.5) +
    stat_summary(aes(group = instruction), fun.y = mean, geom = "line", size = 1.5) +
    labs(x = "", y = "percentage\n") +
    scale_color_manual(values = wesanderson::wes_palette("Darjeeling1", 2, "continuous")) + 
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.915, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

int.plot.val = data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = construct)) +
    stat_summary(aes(group = interaction(construct, valence), linetype = valence), fun.y = mean, geom = "line", position = position_dodge(width = 0.2), alpha = 1) +
    stat_summary(aes(group = interaction(construct, valence)), fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0.2), alpha = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    #coord_cartesian(ylim = c(-.3, .4)) +
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.box = "horizontal",
          legend.position = c(.84, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

int.plot = data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = construct)) +
    stat_summary(aes(group = construct), fun.y = mean, geom = "line", position = position_dodge(width = 0.2), alpha = 1) +
    stat_summary(aes(group = construct), fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0.2), alpha = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    #coord_cartesian(ylim = c(-.3, .4)) +
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          legend.box = "horizontal",
          legend.position = c(.9, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

log.plot = data.complete.mod %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  mutate(responseYN = ifelse(response == "no", 0, 1)) %>%
  ggplot(aes(x = value, y = responseYN, color = construct)) + 
  geom_point(alpha = .1) + 
  stat_smooth(method = "glm", method.args = list(family = "binomial"), alpha = .12) +
  facet_grid(~roi) +
  labs(x = "\nmean parameter estimate (arbitrary units)", y = "response (0 = no, 1 = yes)\n") + 
  guides(linetype = guide_legend(override.aes = list(color = "black"))) +
  scale_color_manual(values = constructs) + 
  scale_y_continuous(breaks = c(0,1)) + 
  theme_minimal(base_size = 16) +
  theme(text = element_text(family = "Futura Medium"),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())

log.model.plot = data.complete.mod %>%
  select(subjectID, responseYN, construct,pgACC, vmPFC, VS) %>%
  mutate(fit = predict(model.2.noval, .))
         
log.model.plot$fit.prob = exp(log.model.plot$fit)/(1 + exp(log.model.plot$fit))

log.model.plot = log.model.plot %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(x = value, y = fit.prob, color = construct)) + 
    geom_point(alpha = .03) + 
    #geom_smooth(alpha = .12) +
    geom_smooth(method = "glm", method.args = list(family = quasibinomial), se = FALSE, size = 1.25, fullrange = TRUE) +
    facet_grid(~roi) +
    labs(x = "\nmean parameter estimate (arbitrary units)", y = "probability of responding yes\n") + 
    guides(linetype = guide_legend(override.aes = list(color = "black"))) +
    scale_color_manual(values = constructs) + 
    scale_y_continuous(limits = c(0, 1), breaks = c(0, .25, .5, .75, 1)) + 
    theme_minimal(base_size = 16) +
    theme(text = element_text(family = "Futura Medium"),
          legend.title = element_text(size = 10),
          legend.text = element_text(size = 9),
          axis.text = element_text(color = "black"),
          axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

ggsave(beh.plot, filename = "behavior_plot.png", width = 8, height = 5, dpi = 300)
ggsave(beh.all.plot, filename = "behavior_all_plot.png", width = 8, height = 5, dpi = 300)
ggsave(beh.all.plot.line, filename = "behavior_all_plot_line.png", width = 8, height = 5, dpi = 300)
ggsave(beh.swap.plot, filename = "behavior_swap_plot.png", width = 8, height = 5, dpi = 300)
ggsave(int.plot.val, filename = "interaction_plot_valence.png", width = 8, height = 5, dpi = 300)
ggsave(int.plot, filename = "interaction_plot.png", width = 8, height = 5, dpi = 300)
ggsave(log.plot, filename = "logistic_plot.png", width = 8, height = 5, dpi = 300)
ggsave(log.model.plot, filename = "logistic_model_plot.png", width = 8, height = 5, dpi = 300)
```

# specificity analysis
* look at individual ROIs
```{r, message=FALSE}
data.complete %>%
  select(pgACC_61, starts_with("sgACC"), starts_with("vmPFC_"), mOFC, NAcc, putamen) %>%
  ggpairs(aes(alpha = 0.01),
          #upper = "blank", 
          switch = "both") +
    theme(panel.background = element_rect(fill = 'white'),
          legend.position = "none", 
          panel.grid.major = element_blank(), 
          axis.ticks = element_blank(), 
          panel.border = element_blank())

model.1.spec = glmer(responseYN ~ construct + (1 | subjectID), family = binomial, 
                data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

model.2.spec = glmer(responseYN ~ construct + pgACC_61 + sgACC_164 + sgACC_165 + vmPFC_64 + vmPFC_65 + mOFC + putamen + NAcc + (1 | subjectID), 
                family = binomial, data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

model.3.spec = glmer(responseYN ~ construct*pgACC_61 + construct*sgACC_164 + construct*sgACC_165 + construct*vmPFC_64 + construct*vmPFC_65 + construct*mOFC + putamen*construct + NAcc*construct + (1 | subjectID), 
                family = binomial, data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

model.4.spec = glmer(responseYN ~ construct*pgACC_61 + construct*sgACC_164 + construct*sgACC_165 + (1 | subjectID), 
                family = binomial, data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

model.5.spec = glmer(responseYN ~ construct*vmPFC_64 + construct*vmPFC_65 + construct*mOFC + (1 | subjectID), 
                family = binomial, data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

model.6.spec = glmer(responseYN ~ construct*putamen + construct*NAcc + (1 | subjectID), 
                family = binomial, data = data.complete.mod, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

anova(model.1.spec, model.2.spec, model.3.spec, model.4.spec, model.5.spec, model.6.spec)

summary(model.5.spec)
summary(model.3.spec)
```

# sensitivity analysis
* include all outliers
```{r}
data.complete.sens = left_join(betas, task, by = c("subjectID", "trial", "run")) %>%
  select(-sdPE) %>%
  group_by(subjectID, roi) %>%
  mutate(sd.roi = sd(meanPE, na.rm = TRUE),
         std = meanPE / sd.roi) %>%
  select(-meanPE, -sd.roi) %>%
  spread(roi, std) %>%
  extract(subjectID, "subNum", "FP([0-9]{3})", remove = FALSE) %>%
  mutate(instruction = as.factor(instruction),
         construct = as.factor(construct),
         item = as.character(item),
         RT = ifelse(RT == "NaN", NA, RT),
         response = ifelse(response == 1, "yes",
                    ifelse(response == 2, "no", NA)),
         responseNum = ifelse(response == "yes" & reversed == 0, 1,
                       ifelse(response == "yes" & reversed == 1, 0,
                       ifelse(response == "no" & reversed == 0, 0,
                       ifelse(response == "no" & reversed == 1, 1, response)))),
         responseNum = as.integer(responseNum),
         responseYN = ifelse(responseNum == 1, "yes",
                      ifelse(responseNum == 0, "no", responseNum)),
         valence = ifelse(construct %in% c("well-being", "social") & reversed == 0, "positive",
                   ifelse(construct %in% c("well-being", "social") & reversed == 1, "negative",
                   ifelse(construct %in% "ill-being" & reversed == 0, "negative",
                   ifelse(construct %in% "ill-being" & reversed == 1, "positive", NA))))) %>%
  filter(!subjectID %in% c("FP091", "FP080", "FP082", "FP021", "FP049", "FP085", "FP121")) %>%
  mutate(response = as.factor(response),
         responseYN = as.factor(responseYN)) %>%
  filter(instruction == "self") %>%
  na.omit()

model.0.sens = glmer(responseYN ~ construct + (1 | subjectID), family = binomial, 
                data = data.complete.sens, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.1.sens = glmer(responseYN ~ construct + valence + (1 | subjectID), family = binomial, 
                data = data.complete.sens, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.2.sens = glmer(responseYN ~ construct + valence + pgACC + vmPFC + VS + (1 | subjectID), family = binomial, 
                data = data.complete.sens, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)
model.3.sens = glmer(responseYN ~ valence + pgACC*construct + vmPFC*construct + VS*construct + (1 | subjectID), family = binomial, 
                data = data.complete.sens, control = glmerControl(optimizer = "bobyqa"), nAGQ = 10)

anova(model.0.sens, model.1.sens, model.2.sens, model.3.sens)

summary(model.3.sens)
```

# other plots
## correlations
```{r, message=FALSE}
instruction.plot = data.complete %>%
  select(instruction, pgACC, vmPFC, VS) %>%
  ggpairs(aes(color = instruction, alpha = 0.01),
          #upper = "blank", 
          switch = "both") +
    theme(panel.background = element_rect(fill = 'white'),
          legend.position = "none", 
          panel.grid.major = element_blank(), 
          axis.ticks = element_blank(), 
          panel.border = element_blank())

for (i in 1:instruction.plot$nrow) {
  for (j in 1:instruction.plot$ncol) {
    instruction.plot[i,j] = instruction.plot[i,j] + 
        scale_fill_manual(values = instructions) +
        scale_color_manual(values = instructions)  
  }
}

construct.plot = data.complete %>%
  select(construct, pgACC, vmPFC, VS) %>%
  ggpairs(aes(color = construct, alpha = 0.01),
          #upper = "blank", 
          switch = "both") +
    theme(panel.background = element_rect(fill = 'white'),
          legend.position = "none", 
          panel.grid.major = element_blank(), 
          axis.ticks = element_blank(), 
          panel.border = element_blank())

for (i in 1:construct.plot$nrow) {
  for (j in 1:construct.plot$ncol) {
    construct.plot[i,j] = construct.plot[i,j] + 
        scale_fill_manual(values = constructs) +
        scale_color_manual(values = constructs)  
  }
}


valence.plot = data.complete %>%
  select(valence, pgACC, vmPFC, VS) %>%
  ggpairs(aes(color = valence, alpha = 0.01),
          #upper = "blank", 
          switch = "both") +
    theme(panel.background = element_rect(fill = 'white'),
          legend.position = "none", 
          panel.grid.major = element_blank(), 
          axis.ticks = element_blank(), 
          panel.border = element_blank())

for (i in 1:valence.plot$nrow) {
  for (j in 1:valence.plot$ncol) {
    valence.plot[i,j] = valence.plot[i,j] + 
        scale_fill_manual(values = valence) +
        scale_color_manual(values = valence)  
  }
}

response.plot = data.complete %>%
  select(response, pgACC, vmPFC, VS) %>%
  ggpairs(aes(color = response, alpha = 0.01),
          #upper = "blank", 
          switch = "both") +
    theme(panel.background = element_rect(fill = 'white'),
          legend.position = "none", 
          panel.grid.major = element_blank(), 
          axis.ticks = element_blank(), 
          panel.border = element_blank())

instruction.plot
construct.plot
valence.plot
response.plot
```

## responses
```{r}
data.complete %>%
  ggplot(aes(responseYN, fill = instruction)) + 
    geom_histogram(stat = "count", position = "dodge", binwidth = .5) +
    facet_grid(~construct) +
    scale_fill_manual(values = instructions) +
    labs(x = "", y = "count\n") +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.percent %>%
  ggplot(aes(construct, percent, color = instruction)) + 
    geom_point(aes(group = interaction(subjectID, construct)), alpha = .1) + 
    geom_line(aes(group = interaction(subjectID, instruction)), alpha = .1) + 
    stat_summary(aes(group = instruction), fun.y = "mean", geom = "point") +
    stat_summary(aes(group = instruction), fun.data = "mean_cl_boot", geom = "linerange", size = 2) +
    stat_summary(aes(group = instruction), fun.y = mean, geom = "line", size = 2) +
    labs(x = "", y = "percent yes\n") +
    scale_color_manual(values = wesanderson::wes_palette("Darjeeling1", 2, "continuous")) + 
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

## interactions
### response
```{r}
data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = .5)) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

### instruction
```{r}
data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(instruction, value, color = instruction)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = instructions) + 
    coord_cartesian(ylim = c(-.4, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = instruction)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = instruction), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = instructions) + 
    coord_cartesian(ylim = c(-.4, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

### construct
```{r}
data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(construct, value, color = construct)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    coord_cartesian(ylim = c(-.35, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = construct)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = construct), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    coord_cartesian(ylim = c(-.35, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

### valence
```{r}
data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(valence, value, color = valence)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = valence) + 
    coord_cartesian(ylim = c(-.25, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = valence)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = valence), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = valence) + 
    coord_cartesian(ylim = c(-.25, .25)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

### full interaction
```{r}
data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = instruction)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = interaction(instruction, construct)), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi + construct) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = instructions) + 
    coord_cartesian(ylim = c(-.4, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = instruction)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = interaction(instruction, valence)), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi + valence) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = instructions) + 
    coord_cartesian(ylim = c(-.4, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

### self trials only
```{r}
data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = .5)) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    coord_cartesian(ylim = c(-.2, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(construct, value, color = construct)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    coord_cartesian(ylim = c(-.2, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(valence, value, color = valence)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", size = 1) +
    theme(legend.position = "none") +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = valence) + 
    coord_cartesian(ylim = c(-.2, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = construct)) +
    stat_summary(aes(group = interaction(construct, valence), linetype = valence), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = 1) +
    stat_summary(aes(group = interaction(construct, valence)), fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = constructs) + 
    #coord_cartesian(ylim = c(-.3, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium", color = "black"),
          axis.line = element_line(colour = "black"),
          legend.box = "horizontal",
          legend.position = c(.84, .15),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())

data.complete %>%
  filter(instruction == "self") %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  ggplot(aes(responseYN, value, color = valence)) +
    stat_summary(fun.data = mean_cl_boot, geom = "pointrange", position = position_dodge(width = 0), alpha = .7, size = 1) +
    stat_summary(aes(group = valence), fun.y = mean, geom = "line", position = position_dodge(width = 0), alpha = .7, size = 1) +
    facet_grid(~roi) +
    labs(x = "", y = "mean parameter estimate (arbitrary units)\n") + 
    scale_color_manual(values = valence) + 
    coord_cartesian(ylim = c(-.2, .4)) +
    theme_minimal(base_size = 12) +
    theme(text = element_text(family = "Futura Medium"),
          axis.line = element_line(colour = "black"),
          legend.position = c(.9, .2),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank())
```

## logisitic regression plots
```{r}
data.complete.mod %>%
  gather(roi, value, pgACC, vmPFC, VS) %>%
  mutate(response = ifelse(response == "no", 0, 1)) %>%
  ggplot(aes(x = value, y = response, color = construct, linetype = valence)) + 
  geom_point(alpha = .1) + 
  stat_smooth(method = "glm", method.args = list(family = "binomial"), alpha = .1) +
  facet_grid(~roi) +
  scale_color_manual(values = constructs) + 
  scale_y_continuous(breaks = c(0,1)) + 
  theme_minimal(base_size = 12) +
  theme(text = element_text(family = "Futura Medium"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
```

## model prediction plots
```{r}
pgACC.range = seq(min(data.complete.mod$pgACC), max(data.complete.mod$pgACC), 0.1)
vmPFC.low = mean(data.complete.mod$vmPFC) - sd(data.complete.mod$vmPFC)
vmPFC.mean = mean(data.complete.mod$vmPFC)
vmPFC.high = mean(data.complete.mod$vmPFC) + sd(data.complete.mod$vmPFC)
VS.low = mean(data.complete.mod$VS) - sd(data.complete.mod$VS)
VS.mean = mean(data.complete.mod$VS)
VS.high = mean(data.complete.mod$VS) + sd(data.complete.mod$VS)

new.data = as.data.frame(expand.grid(subjectID = unique(data.complete.mod$subjectID), pgACC = pgACC.range, vmPFC = c(vmPFC.low, vmPFC.mean, vmPFC.high), VS = c(VS.low, VS.mean, VS.high), valence = unique(data.complete.mod$valence), construct = unique(data.complete.mod$construct)))

new.data$prob = predict(model.2.noval, newdata = new.data, type = 'response')

new.data$vmPFC.level <- factor(new.data$vmPFC, labels = c("low vmPFC", "mean vmPFC", "high vmPFC"), ordered = T)
new.data$VS.level <- factor(new.data$VS, labels = c("low VS", "mean VS", "high VS"), ordered = T)

new.data1 = new.data %>%
  group_by(pgACC, vmPFC.level, VS.level, valence, construct) %>% 
  summarize(prob = mean(prob))
  
ggplot(new.data1, aes(x = pgACC, y = prob, color = vmPFC.level, linetype = VS.level, size = valence)) + 
  geom_smooth(se = FALSE) + 
  facet_grid(~construct) +
  labs(x = "pgACC", y = "P(outcome)") +
  scale_color_manual(values = c("#A3BAC3", "#006989", "#01A7C2")) +
  scale_size_discrete(range = c(.25, .75)) +
  theme_minimal(base_size = 12) +
  theme(text = element_text(family = "Futura Medium"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
 
```
