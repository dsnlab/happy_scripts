---
title: "NV Analysis"
author: "Dani Cosme & Niko Verhoeven"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    highlight: tango
    theme: united
    toc: true
    toc_float: 
      collapsed: TRUE
      smooth_scroll: TRUE
    df_print: paged
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(error = FALSE, message = FALSE)
```

# load libraries
```{r, message=FALSE, warning=FALSE}
if (!require(tidyverse)) {
  install.packages('tidyverse')
}

if (!require(knitr)) {
  install.packages('knitr')
}

if (!require(wesanderson)) {
  install.packages('wesanderson')
}

if (!require(devtools)) {
  install.packages('devtools')
}

if (!require(scorequaltrics)) {
  devtools::install_github('jflournoy/qualtrics')
}
```

# set color palettes
```{r}
palette = wesanderson::wes_palette("Zissou1", n = 4, type = "continuous")
palette_grey = "#54565B"
```


# get survey data
```{r, warning = FALSE}
# define variables
cred_file_location = '~/credentials.yaml.DEFAULT'
sid_column_name = '(subjectID)'
survey_name_filter = 'Freshman Project T1$'
sid_pattern = 'FP[0-9]{3}'
exclude_sid = c('FP999','999') # subject IDs to exclude
identifiableData = c('IPAddress') # exclude when printing duplicates

# load credential file
credentials = scorequaltrics::creds_from_file(cred_file_location)

# filter
surveysAvail = scorequaltrics::get_surveys(credentials)
surveysFiltered = filter(surveysAvail, grepl(survey_name_filter, SurveyName))

# get survey
surveys = scorequaltrics::get_survey_responses(credentials, 
                                               surveyid = surveysFiltered$SurveyID[[1]])

# tidy surveys
surveys1 = surveys %>%
  # select responses matching subject ID pattern
  filter(grepl(sid_pattern, subjectID)) %>%
  # exclude test responses
  filter(!subjectID %in% exclude_sid)

# check number of observations
surveys1 %>%
  group_by(subjectID) %>%
  summarize(n = n()) %>%
  arrange(desc(n))

# select relevant columns
eating = surveys1 %>%
  select(subjectID, SEX, starts_with("GENDER"), starts_with("EAT"), starts_with("EDE"))
```

# load task data
```{r, warning = FALSE}
# define variables and paths
sub_dir = "~/Dropbox (PfeiBer Lab)/FreshmanProject/Tasks/ROC-C/output/FP/"
sub_pattern = "FP[0-9]{3}"
subjects = list.files(sub_dir, pattern = sub_pattern)
runs = c("run1", "run2", "run3")

# initialize data frame
data = data.frame()

# loop through subjects and load data
for (sub in subjects) {
  for (run in runs) {
    file = paste0(sub_dir, sub, '/', sub, '_', run,'.csv')
    tmp = tryCatch(read.csv(file, stringsAsFactors = FALSE) %>%
                   mutate(subjectID = sub,
                          run = run,
                          respCue = as.integer(as.character(respCue)),
                          respRating = as.integer(as.character(respRating)),
                          respEffort = as.integer(as.character(respEffort))), error = function(e) NULL)
      data = bind_rows(data, tmp)
      rm(tmp)
  }
}
```

# tidy task data
```{r}
data1 = data %>%
  # exclude FP001 and FP999
  filter(!subjectID %in% c("FP001", "FP999")) %>%
  # recode values
  mutate(rtCue = ifelse(rtCue == "NaN", NA, rtCue), # NaN as NA
         rtRating = ifelse(rtRating == "NaN", NA, rtRating), # NaN as NA
         rtEffort = ifelse(rtEffort == "NaN", NA, rtEffort), # NaN as NA
         action = ifelse(respCue == 6, "look", # cue button presses
                  ifelse(respCue == 7, "regulate", NA)),
         action = ifelse(cond == "LOOK" & is.na(respCue), "look", # missing cue button presses
                  ifelse(cond == "REGULATE" & is.na(respCue), "regulate", action)),
         action = as.factor(action), # change to factor
         choice = ifelse(cond %in% c("LOOK", "REGULATE"), "no", # choice values
                  ifelse(cond == "CHOOSE", "yes", NA)),
         choice = as.factor(choice), # change to factor
         respRating = respRating - 5, # recode button box presses to 1-4 scale
         respRating = as.integer(respRating), # change to integer
         respEffort = respEffort - 5, # recode button box presses to 1-4 scale
         respEffort = as.integer(respEffort), # change to integer
         ratingDiff = respRating - likingRating) %>% # create difference score
  # extract picture category and picture number
  extract(col = foodPic, into = "category", regex = "(.*)[0-9]{2}", remove = FALSE) %>%
  # add trial number
  group_by(subjectID) %>%
  mutate(trial = row_number()) %>%
  # reorder columns
  select(subjectID, run, trial, action, choice, cond, respCue, everything()) %>%
  ungroup()
```

# craving ratings
## by subject
```{r}
plot.rating = data1 %>%
  group_by(subjectID, action, choice) %>%
  summarize(meanDiff = mean(ratingDiff, na.rm = TRUE)) %>%
  filter(!is.na(action))

ggplot(plot.rating, aes(action, meanDiff)) +
  geom_point(aes(group = subjectID), alpha = .05, size = 3) + 
  geom_line(aes(group = subjectID), alpha = .05, size = 1) + 
  stat_summary(aes(group = 1), color = palette_grey, fun.y = mean, geom = "line") +
  stat_summary(color = palette_grey, fun.data = "mean_cl_boot", size = 1) +
  facet_grid(~choice) +
  labs(y = "mean difference in craving rating") + 
  theme_minimal()

ggplot(plot.rating, aes(choice, meanDiff)) +
  geom_point(aes(group = subjectID), alpha = .05, size = 3) + 
  geom_line(aes(group = subjectID), alpha = .05, size = 1) + 
  stat_summary(aes(group = 1), color = palette_grey, fun.y = mean, geom = "line") +
  stat_summary(color = palette_grey, fun.data = "mean_cl_boot", size = 1) +
  facet_grid(~action) +
  labs(y = "mean difference in craving rating") + 
  theme_minimal()

data1 %>%
  group_by(action, choice) %>%
  summarize(meanDiff = mean(ratingDiff, na.rm = TRUE),
            n = n()) %>%
  kable(digits = 2, format = "pandoc", caption = "mean difference in craving ratings")
```

## individual differences 
```{r, fig.width=10, fig.height=30}
ggplot(plot.rating, aes(action, meanDiff, color = choice)) +
  geom_point(aes(group =  interaction(subjectID, choice), color = choice)) +
  geom_line(aes(group = interaction(subjectID, choice), color = choice)) + 
  facet_wrap(~subjectID, ncol = 5) +
  scale_color_manual(values = c(palette[1],palette[3])) +
  labs(y = "mean craving rating") + 
  theme_minimal()
```
